# Nom del procés que veuràs a GitHub
name: Desplegament Segur i Automàtic al Servidor NUC

# Aquesta acció s'activa cada cop que fas un 'push' a la branca 'main'
on:
  push:
    branches:
      - main

# Defineix les tasques que s'han d'executar
jobs:
  deploy:
    # L'automatització s'executa en un servidor de GitHub amb Ubuntu
    runs-on: ubuntu-latest

    # Defineix els passos del procés
    steps:
      # Aquest és l'únic pas: connectar-se al teu servidor i executar les comandes
      - name: Connectar, actualitzar i reiniciar el servidor
        # Usem una acció pre-feta per facilitar la connexió SSH
        uses: appleboy/ssh-action@master
        with:
          # Agafem les dades dels secrets que has configurat al teu repositori
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 2244 # <--- Port segur que hem configurat
          
          # Aquestes són les comandes que s'executaran al teu servidor, una darrere l'altra
          script: |
            # 1. Anem a la carpeta del teu projecte
            cd ~/projectes/Web_SO
            
            # 2. Descarreguem l'últim estat del repositori remot sense intentar fusionar
            git fetch origin main
            
            # 3. Forcem que els FITXERS SEGUITS PER GIT siguin un clon exacte de la versió remota.
            # Aquesta comanda NO TOCARÀ els fitxers i carpetes especificats al .gitignore.
            git reset --hard origin/main
            
            # 4. Instal·lem les dependències de forma neta i només les de producció
            npm ci --production
            
            # 5. Reiniciem l'aplicació amb PM2 per aplicar tots els canvis de codi
            pm2 restart web-so