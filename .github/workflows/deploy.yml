#!/bin/bash

# --- Script de desplegament automatitzat amb gestiÃ³ de certificats SSL ---

# Atura l'script si alguna comanda falla
set -e

# Ves a la carpeta del projecte. Si falla, atura l'script.
cd /home/nection/projectes/Web_SO || exit

echo "âœ… Iniciant desplegament automÃ tic..."

# Definim els noms dels arxius de certificat que esperem trobar.
# Aquests noms sÃ³n genÃ¨rics, l'script els trobarÃ  igualment.
CERT_FILE_KEY_PATTERN="*-key.pem"
CERT_FILE_PATTERN="*.pem"

# Comprovem si ja existeix un arxiu de clau privada.
# `ls` donarÃ  un error si no troba l'arxiu, per aixÃ² redirigim la sortida d'error.
if ls $CERT_FILE_KEY_PATTERN > /dev/null 2>&1; then
    echo "ğŸ”‘ Certificats SSL ja existents. Saltant generaciÃ³."
else
    echo "â€¼ï¸ No s'han trobat certificats SSL. Generant-los per primer cop..."
    
    # Comanda per generar els certificats per a les IPs del teu NUC
    mkcert localhost 127.0.0.1 ::1 192.168.1.47 192.168.1.38
    
    echo "âœ… Certificats generats correctament."
    
    echo "â€¼ï¸ IMPORTANT: Afegeix '*.pem' al teu arxiu .gitignore per no pujar-los a GitHub!"
    # Comprovem si .gitignore ja tÃ© la regla
    if ! grep -q "*.pem" .gitignore; then
        echo "*.pem" >> .gitignore
        echo "   -> Regla '*.pem' afegida a .gitignore automÃ ticament."
    fi
fi

# Ara, el procÃ©s de sempre:
echo "ğŸšš Descarregant la darrera versiÃ³ des de GitHub..."
git pull

echo "ğŸ“¦ InstalÂ·lant dependÃ¨ncies (si n'hi ha de noves)..."
npm install --production

echo "ğŸš€ Reiniciant el servidor amb PM2..."
# Canvia 'el-meu-servidor' pel nom real de la teva aplicaciÃ³ a PM2
pm2 restart el-meu-servidor

echo "ğŸ‰ Desplegament completat amb Ã¨xit!"