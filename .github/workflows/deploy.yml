#!/bin/bash

# --- Script de desplegament automatitzat amb gestió de certificats SSL ---

# Atura l'script si alguna comanda falla
set -e

# Ves a la carpeta del projecte. Si falla, atura l'script.
cd /home/nection/projectes/Web_SO || exit

echo "✅ Iniciant desplegament automàtic..."

# Definim els noms dels arxius de certificat que esperem trobar.
# Aquests noms són genèrics, l'script els trobarà igualment.
CERT_FILE_KEY_PATTERN="*-key.pem"
CERT_FILE_PATTERN="*.pem"

# Comprovem si ja existeix un arxiu de clau privada.
# `ls` donarà un error si no troba l'arxiu, per això redirigim la sortida d'error.
if ls $CERT_FILE_KEY_PATTERN > /dev/null 2>&1; then
    echo "🔑 Certificats SSL ja existents. Saltant generació."
else
    echo "‼️ No s'han trobat certificats SSL. Generant-los per primer cop..."
    
    # Comanda per generar els certificats per a les IPs del teu NUC
    mkcert localhost 127.0.0.1 ::1 192.168.1.47 192.168.1.38
    
    echo "✅ Certificats generats correctament."
    
    echo "‼️ IMPORTANT: Afegeix '*.pem' al teu arxiu .gitignore per no pujar-los a GitHub!"
    # Comprovem si .gitignore ja té la regla
    if ! grep -q "*.pem" .gitignore; then
        echo "*.pem" >> .gitignore
        echo "   -> Regla '*.pem' afegida a .gitignore automàticament."
    fi
fi

# Ara, el procés de sempre:
echo "🚚 Descarregant la darrera versió des de GitHub..."
git pull

echo "📦 Instal·lant dependències (si n'hi ha de noves)..."
npm install --production

echo "🚀 Reiniciant el servidor amb PM2..."
# Canvia 'el-meu-servidor' pel nom real de la teva aplicació a PM2
pm2 restart el-meu-servidor

echo "🎉 Desplegament completat amb èxit!"